// script.js — Rabbit & Turtle Race (cartoon images embedded)
const FALLBACK_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDMwKSI+CiAgICAgICAgICA8cmVjdCB4PSI2MCIgeT0iODAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMzMzMiLz4KICAgICAgICAgIDxyZWN0IHg9IjIwMCIgeT0iODAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMzMzMiLz4KICAgICAgICAgIDxnPgogICAgICAgICAgICA8cmVjdCB4PSI3NiIgeT0iODAiIHdpZHRoPSIxMjQiIGhlaWdodD0iMjAiIGZpbGw9IiNmZmZmZmYiLz4KICAgICAgICAgICAgPHBhdGggZD0iTTc2IDgwIGgyMCB2MjAgaC0yMHogTTExNiA4MCBoMjAgdjIwIGgtMjB6IE0xNTYgODAgaDIwIHYyMCBoLTIweiIgZmlsbD0iIzAwMCIvPgogICAgICAgICAgPC9nPgogICAgICAgICAgPHBhdGggZD0iTTYwIDIwMCBRMTQwIDIyMCAyMjAgMjAwIiBzdHJva2U9IiM3YmQzODkiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDwvZz4KICAgICAgICAKICAgICAgPHRleHQgeD0nMTUwJyB5PScyMjQnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyNmZmQxNjYnIGZvbnQtZmFtaWx5PSdzeXN0ZW0tdWksU2Vnb2UgVUksUm9ib3RvLEhlbHZldGljYSxBcmlhbCcgZm9udC1zaXplPScxOCc+SW1hZ2UgZmFsbGJhY2s8L3RleHQ+CiAgICA8L3N2Zz4=';

const story = {
  start: {
    text: "It’s race day! Rabbit and Turtle line up. The whistle blows—what will you do?",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwLDIwKSI+CiAgICAgICAgICA8IS0tIFR1cnRsZSAtLT4KICAgICAgICAgIDxlbGxpcHNlIGN4PSI3MCIgY3k9IjEyMCIgcng9IjUyIiByeT0iMzQiIGZpbGw9IiMyZWNjNzEiIHN0cm9rZT0iIzJhOTE1NCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8Y2lyY2xlIGN4PSIzMCIgY3k9IjEyMCIgcj0iMTQiIGZpbGw9IiMyZWNjNzEiIHN0cm9rZT0iIzJhOTE1NCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8Y2lyY2xlIGN4PSI5OCIgY3k9IjExMCIgcj0iNyIgZmlsbD0iIzIzNCIvPgogICAgICAgICAgPHJlY3QgeD0iMTgiIHk9IjExNSIgd2lkdGg9IjEyIiBoZWlnaHQ9IjEwIiBmaWxsPSIjN2JkMzg5Ii8+CiAgICAgICAgICA8IS0tIFJhYmJpdCAtLT4KICAgICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1MCw1MCkiPgogICAgICAgICAgICA8ZWxsaXBzZSBjeD0iOTAiIGN5PSIxMTAiIHJ4PSIzNiIgcnk9IjI2IiBmaWxsPSIjZmZmIiBzdHJva2U9IiNkMGQwZDAiIHN0cm9rZS13aWR0aD0iMyIvPgogICAgICAgICAgICA8Y2lyY2xlIGN4PSI3OCIgY3k9IjEwNCIgcj0iNCIgZmlsbD0iIzMzMyIvPgogICAgICAgICAgICA8ZWxsaXBzZSBjeD0iOTYiIGN5PSI4OCIgcng9IjEyIiByeT0iMjYiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2QwZDBkMCIgc3Ryb2tlLXdpZHRoPSIzIi8+CiAgICAgICAgICAgIDxlbGxpcHNlIGN4PSIxMTQiIGN5PSI4OCIgcng9IjEyIiByeT0iMjYiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2QwZDBkMCIgc3Ryb2tlLXdpZHRoPSIzIi8+CiAgICAgICAgICAgIDxjaXJjbGUgY3g9IjEwMiIgY3k9IjExMCIgcj0iMyIgZmlsbD0iI2ZmNmI2YiIvPgogICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgICAgICAKICAgICAgPHRleHQgeD0nMTUwJyB5PScyMjQnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyNmZmQxNjYnIGZvbnQtZmFtaWx5PSdzeXN0ZW0tdWksU2Vnb2UgVUksUm9ib3RvLEhlbHZldGljYSxBcmlhbCcgZm9udC1zaXplPScxOCc+T24geW91ciBtYXJrcyE8L3RleHQ+CiAgICA8L3N2Zz4=",
    caption: "The crowd cheers!",
    choices: [
      { text: "Rabbit sprints ahead", next: "sprint" },
      { text: "Turtle keeps steady pace", next: "steady" }
    ]
  },
  sprint: {
    text: "Rabbit zooms ahead! A hidden path appears. Risk it?",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDMwKSI+CiAgICAgICAgICA8ZWxsaXBzZSBjeD0iMTIwIiBjeT0iMTIwIiByeD0iNTAiIHJ5PSIzNCIgZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjZDBkMGQwIiBzdHJva2Utd2lkdGg9IjQiLz4KICAgICAgICAgIDxlbGxpcHNlIGN4PSIxMDAiIGN5PSI4MCIgcng9IjE0IiByeT0iMzQiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2QwZDBkMCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8ZWxsaXBzZSBjeD0iMTM2IiBjeT0iODAiIHJ4PSIxNCIgcnk9IjM0IiBmaWxsPSIjZmZmIiBzdHJva2U9IiNkMGQwZDAiIHN0cm9rZS13aWR0aD0iNCIvPgogICAgICAgICAgPGNpcmNsZSBjeD0iMTA4IiBjeT0iMTE2IiByPSI0IiBmaWxsPSIjMzMzIi8+CiAgICAgICAgICA8Y2lyY2xlIGN4PSIxMzAiIGN5PSIxMTYiIHI9IjQiIGZpbGw9IiMzMzMiLz4KICAgICAgICAgIDxjaXJjbGUgY3g9IjEyMCIgY3k9IjEyNiIgcj0iNSIgZmlsbD0iI2ZmNmI2YiIvPgogICAgICAgICAgPHBhdGggZD0iTTE2MCAxNDAgQyAxOTAgMTMwLCAyMjAgMTIwLCAyNDAgMTE4IiBzdHJva2U9IiNmZjlhYzIiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5SYWJiaXQgc3ByaW50cyBhaGVhZDwvdGV4dD4KICAgIDwvc3ZnPg==",
    caption: "Speed is tempting…",
    choices: [
      { text: "Take the shortcut", next: "shortcut" },
      { text: "Stick to the main track", next: "finish" }
    ]
  },
  steady: {
    text: "Turtle jogs steadily and spots a friend stuck in vines.",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwLDMwKSI+CiAgICAgICAgICA8ZWxsaXBzZSBjeD0iMTQwIiBjeT0iMTIwIiByeD0iNjAiIHJ5PSI0MCIgZmlsbD0iIzJlY2M3MSIgc3Ryb2tlPSIjMjU3YTRhIiBzdHJva2Utd2lkdGg9IjUiLz4KICAgICAgICAgIDxwYXRoIGQ9Ik0xMDAgMTAwIGg4MCB2NDAgaC04MCB6IiBmaWxsPSJub25lIiBzdHJva2U9IiMxZTZkNDAiIHN0cm9rZS13aWR0aD0iMyIvPgogICAgICAgICAgPGNpcmNsZSBjeD0iOTYiIGN5PSIxMjAiIHI9IjE0IiBmaWxsPSIjMmVjYzcxIiBzdHJva2U9IiMxZTZkNDAiIHN0cm9rZS13aWR0aD0iNSIvPgogICAgICAgICAgPGNpcmNsZSBjeD0iODgiIGN5PSIxMjAiIHI9IjQiIGZpbGw9IiMxMjMiLz4KICAgICAgICAgIDxyZWN0IHg9IjE3MiIgeT0iMTIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMTAiIGZpbGw9IiMyZWNjNzEiIHN0cm9rZT0iIzFlNmQ0MCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5UdXJ0bGUgam9ncyBzdGVhZGlseTwvdGV4dD4KICAgIDwvc3ZnPg==",
    caption: "Slow and kind can still win.",
    choices: [
      { text: "Help the friend", next: "help_friend" },
      { text: "Ignore and keep going", next: "finish" }
    ]
  },
  shortcut: {
    text: "The path twists… and splits again! Which way?",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwLDMwKSI+CiAgICAgICAgICA8cGF0aCBkPSJNNDAgMTYwIFExMjAgMTIwIDIwMCAxNTAgUTI0MCAxNzAgMjYwIDEzMCIgc3Ryb2tlPSIjNmVhOGZlIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9Im5vbmUiLz4KICAgICAgICAgIDxjaXJjbGUgY3g9IjQwIiBjeT0iMTYwIiByPSI2IiBmaWxsPSIjZmZkMTY2Ii8+CiAgICAgICAgICA8Y2lyY2xlIGN4PSIyNjAiIGN5PSIxMzAiIHI9IjYiIGZpbGw9IiNmZmQxNjYiLz4KICAgICAgICAgIDxwYXRoIGQ9Ik0xNjAgMTIwIEwxNzQgOTAgTDE4OCAxMjAgWiIgZmlsbD0iI2ZmZDE2NiIvPgogICAgICAgIDwvZz4KICAgICAgICAKICAgICAgPHRleHQgeD0nMTUwJyB5PScyMjQnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyNmZmQxNjYnIGZvbnQtZmFtaWx5PSdzeXN0ZW0tdWksU2Vnb2UgVUksUm9ib3RvLEhlbHZldGljYSxBcmlhbCcgZm9udC1zaXplPScxOCc+U2VjcmV0IHNob3J0Y3V0PzwvdGV4dD4KICAgIDwvc3ZnPg==",
    caption: "Shortcuts aren’t always short.",
    choices: [
      { text: "Left toward the sound of water", next: "ending_lost" },
      { text: "Right toward distant cheers", next: "finish" }
    ]
  },
  help_friend: {
    text: "You free the friend, who cheers for you the rest of the way.",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwLDMwKSI+CiAgICAgICAgICA8Y2lyY2xlIGN4PSI5MCIgY3k9IjEyMCIgcj0iMjAiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2QwZDBkMCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cmVjdCB4PSIxMTAiIHk9IjExMCIgd2lkdGg9IjE2IiBoZWlnaHQ9IjIwIiBmaWxsPSIjZmZmIiBzdHJva2U9IiNkMGQwZDAiIHN0cm9rZS13aWR0aD0iNCIvPgogICAgICAgICAgPGxpbmUgeDE9IjExMCIgeTE9IjExMCIgeDI9IjgwIiB5Mj0iOTYiIHN0cm9rZT0iI2ZmOWFjMiIgc3Ryb2tlLXdpZHRoPSI2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KICAgICAgICAgIDxsaW5lIHgxPSIxMjYiIHkxPSIxMzAiIHgyPSIxNjAiIHkyPSIxNTAiIHN0cm9rZT0iI2ZmOWFjMiIgc3Ryb2tlLXdpZHRoPSI2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KICAgICAgICAgIDxwYXRoIGQ9Ik0xODAgMTQwIFExNzAgMTIwIDE1MCAxMjAiIHN0cm9rZT0iIzdiZDM4OSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSJub25lIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5IZWxwIHRoZSBzdHVjayBmcmllbmQ8L3RleHQ+CiAgICA8L3N2Zz4=",
    caption: "Kindness echoes.",
    choices: [
      { text: "Jog to the finish", next: "finish" }
    ]
  },
  finish: {
    text: "The finish line! Who crosses first?",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDMwKSI+CiAgICAgICAgICA8cmVjdCB4PSI2MCIgeT0iODAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMzMzMiLz4KICAgICAgICAgIDxyZWN0IHg9IjIwMCIgeT0iODAiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMzMzMiLz4KICAgICAgICAgIDxnPgogICAgICAgICAgICA8cmVjdCB4PSI3NiIgeT0iODAiIHdpZHRoPSIxMjQiIGhlaWdodD0iMjAiIGZpbGw9IiNmZmZmZmYiLz4KICAgICAgICAgICAgPHBhdGggZD0iTTc2IDgwIGgyMCB2MjAgaC0yMHogTTExNiA4MCBoMjAgdjIwIGgtMjB6IE0xNTYgODAgaDIwIHYyMCBoLTIweiIgZmlsbD0iIzAwMCIvPgogICAgICAgICAgPC9nPgogICAgICAgICAgPHBhdGggZD0iTTYwIDIwMCBRMTQwIDIyMCAyMjAgMjAwIiBzdHJva2U9IiM3YmQzODkiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDwvZz4KICAgICAgICAKICAgICAgPHRleHQgeD0nMTUwJyB5PScyMjQnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyNmZmQxNjYnIGZvbnQtZmFtaWx5PSdzeXN0ZW0tdWksU2Vnb2UgVUksUm9ib3RvLEhlbHZldGljYSxBcmlhbCcgZm9udC1zaXplPScxOCc+RmluaXNoIGxpbmUgYWhlYWQhPC90ZXh0PgogICAgPC9zdmc+",
    caption: "Final push!",
    choices: [
      { text: "Rabbit wins", next: "ending_rabbit_wins" },
      { text: "Turtle wins", next: "ending_turtle_wins" },
      { text: "Hold hands and tie", next: "ending_draw" },
      { text: "Stop to celebrate friendship", next: "ending_friendship" }
    ]
  },

  // Endings
  ending_rabbit_wins: {
    ending: true,
    text: "Rabbit bursts across the line! Speed pays off today.",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDQwKSI+CiAgICAgICAgICA8cGF0aCBkPSJNOTAgMTIwIGgxMDAgdjQwIGgtMTAwIHoiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cGF0aCBkPSJNMTAwIDEyMCBjMCAtNDAgODAgLTQwIDgwIDAiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cmVjdCB4PSIxMzAiIHk9IjE2MCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgICA8cmVjdCB4PSIxMTAiIHk9IjE5MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjE2IiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5FbmRpbmc6IFJhYmJpdCBXaW5zPC90ZXh0PgogICAgPC9zdmc+",
    caption: "Fast feet, big grin."
  },
  ending_turtle_wins: {
    ending: true,
    text: "Turtle wins with steady steps and a happy heart.",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDQwKSI+CiAgICAgICAgICA8cGF0aCBkPSJNOTAgMTIwIGgxMDAgdjQwIGgtMTAwIHoiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cGF0aCBkPSJNMTAwIDEyMCBjMCAtNDAgODAgLTQwIDgwIDAiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cmVjdCB4PSIxMzAiIHk9IjE2MCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgICA8cmVjdCB4PSIxMTAiIHk9IjE5MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjE2IiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5FbmRpbmc6IFR1cnRsZSBXaW5zPC90ZXh0PgogICAgPC9zdmc+",
    caption: "Slow and steady triumphs."
  },
  ending_draw: {
    ending: true,
    text: "They cross together—crowd goes wild! A friendly draw.",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDQwKSI+CiAgICAgICAgICA8cGF0aCBkPSJNOTAgMTIwIGgxMDAgdjQwIGgtMTAwIHoiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cGF0aCBkPSJNMTAwIDEyMCBjMCAtNDAgODAgLTQwIDgwIDAiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cmVjdCB4PSIxMzAiIHk9IjE2MCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgICA8cmVjdCB4PSIxMTAiIHk9IjE5MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjE2IiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5FbmRpbmc6IEEgRnJpZW5kbHkgRHJhdzwvdGV4dD4KICAgIDwvc3ZnPg==",
    caption: "Sportsmanship wins."
  },
  ending_friendship: {
    ending: true,
    text: "They stop to help others and celebrate together. Friendship first!",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDQwKSI+CiAgICAgICAgICA8cGF0aCBkPSJNOTAgMTIwIGgxMDAgdjQwIGgtMTAwIHoiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cGF0aCBkPSJNMTAwIDEyMCBjMCAtNDAgODAgLTQwIDgwIDAiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cmVjdCB4PSIxMzAiIHk9IjE2MCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgICA8cmVjdCB4PSIxMTAiIHk9IjE5MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjE2IiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5FbmRpbmc6IEZyaWVuZHNoaXAgRmlyc3Q8L3RleHQ+CiAgICA8L3N2Zz4=",
    caption: "Best finish of all."
  },
  ending_lost: {
    ending: true,
    text: "The shortcut loops back to the start. You learned a lesson!",
    image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMDAgMjQwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCc+CiAgICAgIDxkZWZzPgogICAgICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nIzFiMzA0ZicvPgogICAgICAgICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjMGQxYTJlJy8+CiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4KICAgICAgPC9kZWZzPgogICAgICA8cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd1cmwoI2cpJy8+CiAgICAgIAogICAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwLDQwKSI+CiAgICAgICAgICA8cGF0aCBkPSJNOTAgMTIwIGgxMDAgdjQwIGgtMTAwIHoiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cGF0aCBkPSJNMTAwIDEyMCBjMCAtNDAgODAgLTQwIDgwIDAiIGZpbGw9IiNmZmQxNjYiIHN0cm9rZT0iI2UzYjY0YiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgICAgICAgICA8cmVjdCB4PSIxMzAiIHk9IjE2MCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgICA8cmVjdCB4PSIxMTAiIHk9IjE5MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjE2IiBmaWxsPSIjY2FhNDNhIi8+CiAgICAgICAgPC9nPgogICAgICAgIAogICAgICA8dGV4dCB4PScxNTAnIHk9JzIyNCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nI2ZmZDE2NicgZm9udC1mYW1pbHk9J3N5c3RlbS11aSxTZWdvZSBVSSxSb2JvdG8sSGVsdmV0aWNhLEFyaWFsJyBmb250LXNpemU9JzE4Jz5FbmRpbmc6IExvc3Qgb24gdGhlIFNob3J0Y3V0PC90ZXh0PgogICAgPC9zdmc+",
    caption: "Not all shortcuts help."
  }
};

let current = "start";

function endGame(node){
  const storyEl = document.getElementById('story');
  const choicesEl = document.getElementById('choices');
  const imgEl = document.getElementById('story-image');
  const capEl = document.getElementById('caption');
  const restartBtn = document.getElementById('restartBtn');

  storyEl.textContent = node.text;
  imgEl.onerror = () => { if (imgEl.src !== FALLBACK_IMAGE) imgEl.src = FALLBACK_IMAGE; };
  imgEl.src = (node.image && node.image.trim()) ? node.image : FALLBACK_IMAGE;
  capEl.textContent = node.caption || "";
  choicesEl.innerHTML = "";
  restartBtn.hidden = false;
}

function render(){
  const node = story[current];
  const storyEl = document.getElementById('story');
  const choicesEl = document.getElementById('choices');
  const imgEl = document.getElementById('story-image');
  const capEl = document.getElementById('caption');
  const restartBtn = document.getElementById('restartBtn');

  if(!node){
    storyEl.textContent = "Missing scene: " + current;
    choicesEl.innerHTML = "";
    imgEl.src = FALLBACK_IMAGE;
    capEl.textContent = "";
    restartBtn.hidden = false;
    return;
  }

  storyEl.textContent = node.text;
  imgEl.onerror = () => { if (imgEl.src !== FALLBACK_IMAGE) imgEl.src = FALLBACK_IMAGE; };
  imgEl.src = (node.image && node.image.trim()) ? node.image : FALLBACK_IMAGE;
  capEl.textContent = node.caption || "";

  choicesEl.innerHTML = "";

  if(node.ending){
    endGame(node);
    return;
  }

  restartBtn.hidden = true;
  (node.choices || []).forEach((c, i) => {
    const btn = document.createElement('button');
    btn.textContent = c.text;
    btn.setAttribute('aria-label', c.text);
    btn.addEventListener('click', () => { current = c.next; render(); });
    btn.dataset.choiceIndex = i + 1;
    choicesEl.appendChild(btn);
  });
}

function startGame(){
  current = "start";
  render();
}

document.getElementById('restartBtn').addEventListener('click', startGame);
document.addEventListener('keydown', (e) => {
  if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  const k = e.key;
  if (k >= '1' && k <= '9'){
    const idx = parseInt(k,10);
    const btn = document.querySelector(`.choices button[data-choice-index="${idx}"]`);
    if(btn) btn.click();
  }
});
document.addEventListener('DOMContentLoaded', startGame);
